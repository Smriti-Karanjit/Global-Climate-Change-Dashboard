<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Global Temperature Anomalies</title>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <style>
    body {
      background-color: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      margin: 0;
      overflow-x: hidden;
    }

    h1 {
      text-align: center;
      margin-top: 15px;
      font-weight: 600;
    }

    .slider_container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin: 10px 0 20px;
      flex-wrap: wrap;
    }

    #year_slider {
      width: 250px;
    }

    #map {
      width: 100%;
      height: auto;
      display: block;
      background-color: black;
    }

    .country {
      transition: filter 0.2s;
    }

    .country:hover {
      filter: brightness(1.2);
    }

    .highlighted {
      stroke: #000;
      stroke-width: 2px;
      filter: brightness(1.3);
    }

    .tooltip {
      position: absolute;
      pointer-events: none;
      background: rgba(32, 30, 30, 0.9);
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.4);
      color: white;
      width: 260px;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .tooltip svg {
      width: 240px;
      height: 100px;
    }

    .legend-label {
      font-size: 12px;
      fill: white;
    }
  </style>
</head>

<body>
  <h1>Global Temperature Anomalies by Year</h1>

  <div class="slider_container">
    <label for="year_slider">Year: <span id="year_display">1950</span></label>
    <input type="range" id="year_slider" min="1950" max="2023" step="1" value="1950" />
  </div>

  <svg id="map" viewBox="0 0 960 540" preserveAspectRatio="xMidYMid meet"></svg>

  <script>
    const svg = d3.select("#map");
    const g = svg.append("g");
    const tooltip = d3.select("body").append("div").attr("class", "tooltip");

    const projection = d3.geoMercator();
    const path = d3.geoPath().projection(projection);

    const colorScale = d3
      .scaleLinear()
      .domain([-2, -1.5, -1, -0.5, 0, 0.5, 1, 1.5, 2])
      .range([
        "#08306b",
        "#2171b5",
        "#6baed6",
        "#c6dbef",
        "#deebf7",
        "#fee5d9",
        "#fcae91",
        "#fb6a4a",
        "#cb181d",
      ]);

    const countryMapping = {
      "United States of America": "United States",
      "Bosnia and Herz.": "Bosnia and Herzegovina",
    };

    Promise.all([
      d3.json("https://raw.githubusercontent.com/Smriti-Karanjit/Global-Climate-Change-Dashboard/refs/heads/main/Climate%20Change%20Dashboard/json/custom.geo.json"),
      d3.csv("https://raw.githubusercontent.com/Smriti-Karanjit/Global-Climate-Change-Dashboard/refs/heads/main/Climate%20Change%20Dashboard/data/annual-temperature-anomalies.csv", (d) => ({
        Entity: d.Entity,
        Year: +d.Year,
        Anomaly: +d["Temperature anomaly"],
      })),
    ]).then(([geoData, tempData]) => {
      let selectedYear = 1950;

      // Create legend
      const legendG = svg.append("g").attr("class", "legend");

      function drawLegend(width) {
        legendG.selectAll("*").remove();
        const legendWidth = Math.min(width * 0.5, 300);
        const legendHeight = 15;
        const legendX = (width - legendWidth) / 2;
        const legendY = svg.node().viewBox.baseVal.height - 50;

        const defs = svg.append("defs");
        const gradient = defs.append("linearGradient")
          .attr("id", "legend-gradient")
          .attr("x1", "0%").attr("y1", "0%")
          .attr("x2", "100%").attr("y2", "0%");

        const stops = [
          { o: "0%", c: "#08306b" },
          { o: "20%", c: "#2171b5" },
          { o: "30%", c: "#6baed6" },
          { o: "40%", c: "#c6dbef" },
          { o: "50%", c: "#deebf7" },
          { o: "60%", c: "#fee5d9" },
          { o: "75%", c: "#fcae91" },
          { o: "87.5%", c: "#fb6a4a" },
          { o: "100%", c: "#cb181d" },
        ];
        stops.forEach(s => gradient.append("stop").attr("offset", s.o).attr("stop-color", s.c));

        legendG.append("rect")
          .attr("x", legendX).attr("y", legendY)
          .attr("width", legendWidth).attr("height", legendHeight)
          .style("fill", "url(#legend-gradient)");

        const scale = d3.scaleLinear().domain([-2, 2]).range([legendX, legendX + legendWidth]);
        const axis = d3.axisBottom(scale)
          .tickValues([-2, -1, 0, 1, 2])
          .tickFormat(d => `${d}°C`);

        legendG.append("g")
          .attr("transform", `translate(0, ${legendY + legendHeight})`)
          .call(axis)
          .selectAll("text").classed("legend-label", true);
      }

      // Projection + responsive handler
      const updateProjection = () => {
        const width = svg.node().clientWidth;
        const height = width * 0.55;
        svg.attr("viewBox", `0 0 ${width} ${height}`);

        projection
          .scale(width / 6)
          .translate([width / 2, height / 1.5]);

        drawLegend(width);
        updateMap(selectedYear);
      };

      const updateMap = (year) => {
        const yearData = tempData.filter((d) => d.Year === year);

        g.selectAll(".country")
          .data(geoData.features)
          .join("path")
          .attr("class", "country")
          .attr("d", path)
          .attr("fill", (d) => {
            const countryName = countryMapping[d.properties.name] || d.properties.name;
            const data = yearData.find((c) => c.Entity === countryName);
            return data ? colorScale(data.Anomaly) : "#444";
          })
          .attr("stroke", "#333")
          .attr("stroke-width", 0.5)
          .on("mouseover", function (event, d) {
            d3.select(this).classed("highlighted", true);
            const countryName = countryMapping[d.properties.name] || d.properties.name;
            const data = tempData.filter((c) => c.Entity === countryName);
            showTooltip(event, countryName, data);
          })
          .on("mousemove", (event) => {
            tooltip
              .style("left", event.pageX + 15 + "px")
              .style("top", event.pageY - 20 + "px");
          })
          .on("mouseout", function () {
            d3.select(this).classed("highlighted", false);
            tooltip.style("opacity", 0);
          });
      };

      function showTooltip(event, name, data) {
        tooltip.transition().duration(150).style("opacity", 1);

        const current = data.find((d) => d.Year === selectedYear);
        const temp = current ? current.Anomaly.toFixed(2) + "°C" : "N/A";
        const color = colorScale(current ? current.Anomaly : 0);

        tooltip.html(`
          <div style="display:flex;justify-content:space-between;">
            <strong>${name}</strong>
            <span style="color:${color};font-weight:700;">${temp}</span>
          </div>
          <small>${selectedYear}</small>
          <svg></svg>
        `);

        const svgMini = tooltip.select("svg");
        const w = 240, h = 80;
        const x = d3.scaleLinear().domain([1940, 2023]).range([0, w]);
        const y = d3.scaleLinear().domain([-3, 3]).range([h, 0]);
        const line = d3.line().x(d => x(d.Year)).y(d => y(d.Anomaly));

        const gradId = "grad" + Math.random().toString(36).slice(2);
        const defs = svgMini.append("defs");
        const grad = defs.append("linearGradient")
          .attr("id", gradId)
          .attr("x1", "0%").attr("x2", "100%")
          .attr("y1", "0%").attr("y2", "0%");
        grad.selectAll("stop")
          .data(data)
          .enter().append("stop")
          .attr("offset", (d,i) => `${(i/(data.length-1))*100}%`)
          .attr("stop-color", d => colorScale(d.Anomaly));

        svgMini.append("path")
          .datum(data)
          .attr("fill", "none")
          .attr("stroke", `url(#${gradId})`)
          .attr("stroke-width", 2)
          .attr("d", line);

        const avg = d3.mean(data, d => d.Anomaly);
        svgMini.append("line")
          .attr("x1", 0).attr("x2", w)
          .attr("y1", y(avg)).attr("y2", y(avg))
          .attr("stroke", "#fff").attr("stroke-dasharray", "3,2")
          .attr("stroke-width", 1);

        const xAxis = d3.axisBottom(x)
          .tickValues([1940, 2023])
          .tickFormat(d3.format("d"));
        svgMini.append("g")
          .attr("transform", `translate(0,${h})`)
          .call(xAxis)
          .selectAll("text").attr("fill","#fff").attr("font-size","9px");
      }

      d3.select("#year_slider").on("input", function () {
        selectedYear = +this.value;
        d3.select("#year_display").text(selectedYear);
        updateMap(selectedYear);
      });

      window.addEventListener("resize", updateProjection);
      updateProjection();
    });
  </script>
</body>
</html>
